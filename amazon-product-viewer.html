<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amazon Product Images — Carousel + Separate Zoom Preview</title>
  <style>
    :root{--accent:#06b6d4;--muted:#64748b}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f6f8fb;color:#0b1220}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:20px;margin:0 0 6px}
    p.lead{color:var(--muted);margin:0 0 14px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .small{font-size:13px;color:var(--muted);margin-top:8px}

    .meta-row{display:flex;gap:12px;align-items:baseline;margin-bottom:12px}
    .title{font-weight:600;font-size:18px}
    .price{font-size:18px;color:#b91c1c;font-weight:700;margin-left:8px}

    .product-gallery{display:grid;grid-template-columns:1fr 140px;gap:16px;align-items:start}
    .main-panel{background:white;border-radius:12px;padding:12px;position:relative;overflow:hidden}
    .stage{width:100%;height:560px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#f3f5f9;cursor:zoom-in;position:relative}
    .stage img{max-width:100%;max-height:100%;object-fit:contain;display:block;user-select:none}

    /* Separate zoom preview */
    .zoom-window{position:absolute;right:12px;top:12px;width:360px;height:360px;border-radius:8px;overflow:hidden;background:#fff;box-shadow:0 12px 28px rgba(11,18,32,.12);display:none;z-index:30}
    .zoom-window img{position:absolute;transform-origin:top left}

    .lens{position:absolute;border-radius:6px;box-shadow:0 6px 18px rgba(11,18,32,.25);pointer-events:none;display:none;z-index:20}

    .thumbs{display:flex;flex-direction:column;gap:8px}
    .thumb{width:120px;height:120px;border-radius:8px;overflow:hidden;background:#fff;border:2px solid transparent;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb.active{border-color:var(--accent)}

    .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(11,18,32,.6);color:white;border:none;width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .nav-btn.left{left:8px}
    .nav-btn.right{right:8px}

    .lightbox{position:fixed;inset:0;background:rgba(2,6,23,.88);display:none;align-items:center;justify-content:center;padding:24px;z-index:9999}
    .lightbox .inner{max-width:1200px;width:100%;height:90%;background:#fff;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}
    .lightbox img{max-width:100%;max-height:100%;object-fit:contain}
    .close-lb{position:absolute;top:12px;right:12px;background:transparent;border:0;color:white;font-size:28px;cursor:pointer}

    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .manual-paste{margin-top:12px}
    textarea{width:100%;min-height:72px;padding:8px;border-radius:8px;border:1px solid #e6edf3;font-size:14px;resize:vertical}
    .grid-row{display:flex;gap:12px;margin-top:12px}
    .note{font-size:13px;color:var(--muted)}
    @media (max-width:980px){
      .product-gallery{grid-template-columns:1fr}
      .thumbs{flex-direction:row;overflow:auto;padding-bottom:8px}
      .thumb{width:90px;height:90px}
      .zoom-window{display:none}
      .stage{height:420px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Amazon Product Viewer</h1>
    <p class="lead">Paste an Amazon URL or ASIN and click <strong>Load Product</strong>. The page will try to load images and fetch title & price (via a free CORS proxy). If metadata fetch is blocked, paste image URLs or title/price manually in the fields below.</p>

    <div class="controls" role="search" aria-label="Load Amazon product">
      <input id="productInput" type="text" placeholder="Paste Amazon URL (https://www.amazon.com/dp/B0...) or ASIN (B0...)" />
      <button id="loadBtn">Load Product</button>
      <button id="fetchMeta" style="background:#334155">Fetch title & price</button>
    </div>
    <div class="small">Examples: <code>https://www.amazon.com/dp/B0C7XYZ123</code> or <code>B0C7XYZ123</code></div>

    <div class="meta-row" style="margin-top:12px">
      <div class="title" id="productTitle">—</div>
      <div class="price" id="productPrice"></div>
    </div>

    <div class="status" id="status">Idle.</div>

    <section class="product-gallery" aria-label="Product image gallery" id="galleryWrap" style="margin-top:16px;display:none">
      <div class="main-panel">
        <div class="stage" id="stage" tabindex="0" aria-label="Main product image" role="img">
          <button class="nav-btn left" id="prev" aria-label="Previous image">◀</button>
          <img id="mainImg" src="" alt="Product image" />
          <button class="nav-btn right" id="next" aria-label="Next image">▶</button>

          <!-- lens shows area under cursor -->
          <div class="lens" id="lens"></div>

          <!-- separate zoom preview -->
          <div class="zoom-window" id="zoomWindow"><img id="zoomImg" src="" alt="Zoomed image"></div>
        </div>

        <div class="grid-row" style="margin-top:10px">
          <div style="flex:1">
            <div class="note">Tip: Hover to magnify on desktop. Click image to open fullscreen. If title/price aren't fetched, click "Fetch title & price" or paste them manually below.</div>
          </div>
          <div style="width:160px"></div>
        </div>
      </div>

      <aside class="thumbs" id="thumbs" aria-label="Image thumbnails"></aside>
    </section>

    <div class="manual-paste" aria-label="Manual image URLs">
      <label class="small">Fallback: Paste direct image URLs (one per line):</label>
      <textarea id="manualUrls" placeholder="https://m.media-amazon.com/images/I/....jpg"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="useManual">Use Pasted Images</button>
        <button id="clearManual" style="background:#d1d5db;color:#0b1220">Clear</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="small">Fallback: Paste title and price (if automatic fetch fails):</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="manualTitle" type="text" placeholder="Product title (fallback)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6edf3" />
        <input id="manualPrice" type="text" placeholder="$0.00" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e6edf3" />
        <button id="applyManualMeta" style="background:#0f1724">Apply</button>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true">
    <button class="close-lb" id="closeLb" aria-label="Close">✕</button>
    <div class="inner" id="lbInner">
      <img id="lbImg" src="" alt="Fullscreen product image">
    </div>
  </div>

<script>
/* ========== Utilities ========== */
function extractASIN(input){
  if(!input) return null;
  input = input.trim();
  try {
    const url = new URL(input);
    const dp = url.pathname.match(/\/dp\/([A-Z0-9]{10})/i);
    if(dp) return dp[1];
    const gp = url.pathname.match(/\/gp\/product\/([A-Z0-9]{10})/i);
    if(gp) return gp[1];
    const generic = url.pathname.match(/\/([A-Z0-9]{10})(?:[\/]|$)/i);
    if(generic) return generic[1];
    const asinq = url.searchParams.get('ASIN') || url.searchParams.get('asin');
    if(asinq) return asinq;
  } catch (err) {
    // not a URL
  }
  const just = input.match(/^([A-Z0-9]{10})$/i);
  if(just) return just[1];
  return null;
}

/* Candidate image URL generation (common patterns) */
function generateCandidateUrls(asin){
  const suffixes = [
    '._AC_SL1500_.jpg',
    '._SL1500_.jpg',
    '._AC_SL1000_.jpg',
    '._SX679_.jpg',
    '._AC_SX679_.jpg',
    '._UY879_.jpg'
  ];
  const numbered = ['', '.01', '.02', '.03', '.04', '.05'];
  const hosts = ['https://m.media-amazon.com/images/I/', 'https://images-na.ssl-images-amazon.com/images/I/'];
  const candidates = [];
  hosts.forEach(host=>{
    numbered.forEach(n=>{
      suffixes.forEach(s=>{
        candidates.push(`${host}${asin}${n}${s}`);
      });
    });
  });
  const alt = ['_01','_02','_03'];
  alt.forEach(n=>{ hosts.forEach(h=>{ candidates.push(`${h}${asin}${n}.jpg`); candidates.push(`${h}${asin}${n}._SL1500_.jpg`); }); });
  return Array.from(new Set(candidates)).slice(0, 80);
}

/* Preload-test an image URL */
function testImage(url, timeout = 6500){
  return new Promise((resolve)=>{
    const img = new Image();
    let done=false;
    const onload = ()=>{ if(done) return; done=true; cleanup(); resolve({url, ok:true}); };
    const onerror = ()=>{ if(done) return; done=true; cleanup(); resolve({url, ok:false}); };
    const cleanup = ()=>{ img.onload=img.onerror=null; clearTimeout(t); };
    img.onload = onload; img.onerror = onerror; img.src = url;
    const t = setTimeout(()=>{ if(done) return; done=true; cleanup(); resolve({url, ok:false, timeout:true}); }, timeout);
  });
}

/* ========== DOM refs & gallery logic ========== */
const productInput = document.getElementById('productInput');
const loadBtn = document.getElementById('loadBtn');
const fetchMetaBtn = document.getElementById('fetchMeta');
const status = document.getElementById('status');
const galleryWrap = document.getElementById('galleryWrap');
const thumbs = document.getElementById('thumbs');
const manualUrls = document.getElementById('manualUrls');
const useManual = document.getElementById('useManual');
const clearManual = document.getElementById('clearManual');
const manualTitle = document.getElementById('manualTitle');
const manualPrice = document.getElementById('manualPrice');
const applyManualMeta = document.getElementById('applyManualMeta');
const productTitle = document.getElementById('productTitle');
const productPrice = document.getElementById('productPrice');

const mainImg = document.getElementById('mainImg');
const zoomImg = document.getElementById('zoomImg');
const lens = document.getElementById('lens');
const zoomWindow = document.getElementById('zoomWindow');
const prev = document.getElementById('prev');
const next = document.getElementById('next');
const stage = document.getElementById('stage');

const lightbox = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const closeLb = document.getElementById('closeLb');

let images = [];
let idx = 0;

function showStatus(txt){ status.textContent = txt; }

/* Populate gallery with found images */
function setImages(imgs){
  images = imgs.slice();
  idx = 0;
  if(images.length===0){
    galleryWrap.style.display = 'none';
    showStatus('No images found. Try pasting direct image URLs or use a backend.');
    return;
  }
  thumbs.innerHTML = '';
  images.forEach((src,i)=>{
    const t = document.createElement('button');
    t.className='thumb';
    t.setAttribute('aria-label','View image '+(i+1));
    t.innerHTML = `<img src="${src}" loading="lazy" alt="Thumbnail ${i+1}">`;
    t.addEventListener('click',()=>goTo(i));
    thumbs.appendChild(t);
  });
  update();
  galleryWrap.style.display = '';
  showStatus(`Loaded ${images.length} image(s).`);
}

function update(){
  const src = images[idx];
  mainImg.src = src;
  mainImg.alt = `Product image ${idx+1}`;
  zoomImg.src = src;
  lbImg.src = src;
  Array.from(thumbs.children).forEach((c,i)=> c.classList.toggle('active', i===idx));
}

function goTo(i){ idx = (i+images.length)%images.length; update(); }
function nextImg(){ goTo(idx+1); }
function prevImg(){ goTo(idx-1); }

/* Carousel controls */
next.addEventListener('click', nextImg);
prev.addEventListener('click', prevImg);
stage.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight') nextImg(); if(e.key==='ArrowLeft') prevImg(); if(e.key==='Enter') openLightbox(); });
mainImg.addEventListener('click', openLightbox);
closeLb.addEventListener('click', closeLightbox);
lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox) closeLightbox(); });

/* Hover magnifier + separate zoom preview (desktop) */
let isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints>0;
if(!isTouch){
  stage.addEventListener('mousemove', onHover);
  stage.addEventListener('mouseenter', onEnter);
  stage.addEventListener('mouseleave', onLeave);
} else {
  let lastTap=0;
  stage.addEventListener('touchend',(e)=>{ const now=Date.now(); if(now-lastTap<350) openLightbox(); lastTap=now; });
}

function onEnter(){ lens.style.display='block'; zoomWindow.style.display='block'; }
function onLeave(){ lens.style.display='none'; zoomWindow.style.display='none'; }

function onHover(e){
  const rect = stage.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const lensW = Math.min(220, rect.width/2);
  const lensH = Math.min(220, rect.height/2);
  lens.style.width = lensW+'px'; lens.style.height = lensH+'px';
  let left = x - lensW/2; let top = y - lensH/2;
  left = Math.max(0, Math.min(rect.width - lensW, left));
  top = Math.max(0, Math.min(rect.height - lensH, top));
  lens.style.left = left + 'px'; lens.style.top = top + 'px';
  const img = mainImg;
  const naturalW = zoomImg.naturalWidth || img.width;
  const naturalH = zoomImg.naturalHeight || img.height;
  const scaleX = naturalW / img.width;
  const scaleY = naturalH / img.height;
  const sx = left * scaleX;
  const sy = top * scaleY;
  zoomImg.style.width = naturalW + 'px';
  zoomImg.style.height = naturalH + 'px';
  zoomImg.style.left = -sx + 'px';
  zoomImg.style.top = -sy + 'px';
  zoomWindow.style.right = '12px';
  zoomWindow.style.top = '12px';
}

/* Lightbox */
function openLightbox(){
  lightbox.style.display='flex';
  let isDown=false, startX, startY, ox=0, oy=0;
  const img = lbImg;
  img.style.transform = 'translate(0px,0px) scale(1)';
  img.style.cursor = 'grab';
  function down(e){ isDown=true; startX = e.clientX || (e.touches && e.touches[0].clientX); startY = e.clientY || (e.touches && e.touches[0].clientY); img.style.cursor='grabbing'; }
  function up(){ isDown=false; img.style.cursor='grab'; }
  function move(e){ if(!isDown) return; const cx = e.clientX || (e.touches && e.touches[0].clientX); const cy = e.clientY || (e.touches && e.touches[0].clientY); const dx = cx - startX; const dy = cy - startY; startX = cx; startY = cy; ox += dx; oy += dy; img.style.transform = `translate(${ox}px, ${oy}px) scale(1.05)`; }
  img.addEventListener('mousedown', down); img.addEventListener('touchstart', down);
  window.addEventListener('mouseup', up); window.addEventListener('touchend', up);
  window.addEventListener('mousemove', move); window.addEventListener('touchmove', move);
  closeLb.onclick = ()=>{ up(); img.removeEventListener('mousedown', down); img.removeEventListener('touchstart', down); window.removeEventListener('mouseup', up); window.removeEventListener('touchend', up); window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move); lightbox.style.display='none'; };
}
function closeLightbox(){ lightbox.style.display='none'; }

/* ========== Metadata fetching ========== */

/*
  CORS note:
  Browsers block direct fetches to amazon.com from client-side due to CORS.
  We use the free AllOrigins proxy below to fetch the product HTML:
    https://api.allorigins.win/raw?url=<encoded product url>
  This works for many cases but may be rate-limited or blocked occasionally.
  For production use, host a small server-side proxy (Node/Express) that fetches Amazon pages and returns HTML.
*/

async function fetchProductMetadata(asin){
  const productUrl = `https://www.amazon.com/dp/${asin}`;
  const proxy = 'https://api.allorigins.win/raw?url=';
  const fetchUrl = proxy + encodeURIComponent(productUrl);
  showStatus('Fetching product page (via proxy) for title & price...');
  try{
    const res = await fetch(fetchUrl);
    if(!res.ok) throw new Error('Proxy fetch failed: ' + res.status);
    const html = await res.text();
    // Parse HTML to extract title & price
    const doc = new DOMParser().parseFromString(html, 'text/html');
    // Title selectors
    const titleEl = doc.querySelector('#productTitle') || doc.querySelector('span#title') || doc.querySelector('h1');
    const title = titleEl ? titleEl.textContent.trim() : null;
    // Price selectors (check common ones)
    const priceSelectors = [
      '#priceblock_dealprice',
      '#priceblock_ourprice',
      '#priceblock_saleprice',
      '.a-offscreen', // sometimes price spans with this class
      '.priceBlockBuyingPriceString'
    ];
    let price = null;
    for(const s of priceSelectors){
      const el = doc.querySelector(s);
      if(el && el.textContent.trim()){
        price = el.textContent.trim();
        break;
      }
    }
    // fallback: search for meta price
    if(!price){
      const metaPrice = doc.querySelector('meta[itemprop="price"]');
      if(metaPrice && metaPrice.getAttribute('content')) price = metaPrice.getAttribute('content');
    }
    return { title, price, rawHtml: html };
  } catch(err){
    console.warn('Metadata fetch error', err);
    return { title: null, price: null, error: err.message || String(err) };
  }
}

/* ========== Main: load images & metadata ========== */

loadBtn.addEventListener('click', async ()=>{
  const raw = productInput.value.trim();
  if(!raw){ showStatus('Enter an Amazon URL or ASIN.'); return; }
  showStatus('Parsing ASIN...');
  const asin = extractASIN(raw);
  if(!asin){ showStatus('Could not extract ASIN. Paste a valid Amazon URL or 10-char ASIN.'); return; }
  showStatus(`ASIN: ${asin}. Generating candidate image URLs...`);
  const candidates = generateCandidateUrls(asin);
  showStatus(`Testing ${candidates.length} candidate image URLs...`);
  const concurrency = 8;
  let found = [];
  let pos = 0;
  async function worker(){
    while(true){
      const i = pos++;
      if(i>=candidates.length) break;
      const cand = candidates[i];
      const res = await testImage(cand, 6500);
      if(res.ok) found.push(cand);
      if(i % 8 === 0) showStatus(`Checked ${Math.min(i+1,candidates.length)}/${candidates.length} — found ${found.length} images...`);
    }
  }
  await Promise.all(Array.from({length: concurrency}, ()=>worker()));
  found = Array.from(new Set(found));
  if(found.length){
    showStatus(`Found ${found.length} images. Loading gallery...`);
    setImages(found);
  } else {
    showStatus('No images found automatically. Try pasting direct image URLs below or click "Fetch title & price" to try fetching metadata.');
    galleryWrap.style.display = 'none';
  }

  // try to fetch metadata automatically (non-blocking)
  productTitle.textContent = '—';
  productPrice.textContent = '';
  const meta = await fetchProductMetadata(asin);
  if(meta.error){
    showStatus('Metadata fetch failed (proxy/CORS). You can paste title/price manually below.');
    if(meta.title) productTitle.textContent = meta.title;
    if(meta.price) productPrice.textContent = meta.price;
  } else {
    if(meta.title) productTitle.textContent = meta.title; else productTitle.textContent = '—';
    if(meta.price) productPrice.textContent = meta.price; else productPrice.textContent = '';
    if(!meta.title && !meta.price){
      showStatus('Loaded images; product title & price not found via proxy. You may paste them manually.');
    } else {
      showStatus('Loaded images and product metadata (via proxy).');
    }
  }
});

fetchMetaBtn.addEventListener('click', async ()=>{
  const raw = productInput.value.trim();
  if(!raw){ showStatus('Enter Amazon URL or ASIN then click this to fetch metadata.'); return; }
  const asin = extractASIN(raw);
  if(!asin){ showStatus('Could not extract ASIN.'); return; }
  showStatus('Fetching metadata...');
  const meta = await fetchProductMetadata(asin);
  if(meta.error){ showStatus('Metadata fetch failed: ' + meta.error); return; }
  if(meta.title) productTitle.textContent = meta.title;
  if(meta.price) productPrice.textContent = meta.price;
  showStatus('Metadata loaded.');
});

/* manual paste usage */
useManual.addEventListener('click', ()=>{
  const text = manualUrls.value.trim();
  if(!text){ showStatus('Paste one or more image URLs first.'); return; }
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const good = lines.filter(u=>/^https?:\/\/.+\.(jpg|jpeg|png|webp)$/i.test(u));
  if(good.length===0){ showStatus('No valid image URLs detected. Make sure each line is a full URL ending in .jpg/.png/.webp'); return; }
  showStatus(`Using ${good.length} pasted image(s).`);
  setImages(good);
});
clearManual.addEventListener('click', ()=>{ manualUrls.value=''; showStatus('Manual URLs cleared.'); });

applyManualMeta.addEventListener('click', ()=>{
  const t = manualTitle.value.trim();
  const p = manualPrice.value.trim();
  if(t) productTitle.textContent = t;
  if(p) productPrice.textContent = p;
  showStatus('Manual title/price applied.');
});

/* small placeholder */
productInput.placeholder = 'https://www.amazon.com/dp/B09EXAMPLE or B09EXAMPLE';

</script>
</body>
</html>
